# 八字计算算法修复文档

## 概述

本文档记录了八字计算算法的修复过程和问题分析。

## 发现的问题

### 问题1：月柱计算错误

**现象**：
- 输入：1999年10月17日 03时00分
- 期望月柱：甲戌（木土）
- 实际月柱：癸未（水土）或乙酉（木金）

**原因**：
1. 节气到月份的映射错误
   - 错误映射：秋分、寒露、霜降 → "未"（七月）
   - 正确映射：秋分、寒露、霜降 → "酉"（八月）
2. 五虎遁法计算月份顺序错误

**修复位置**：`src/bazi_calculator/core/calendar.py`

#### 修复1.1：节气映射
```python
# 修复前
"秋分": ("未", "七月"),
"寒露": ("未", "七月"),
"霜降": ("未", "七月"),
"立冬": ("申", "八月"),

# 修复后
"秋分": ("酉", "八月"),
"寒露": ("酉", "八月"),
"霜降": ("酉", "八月"),
"立冬": ("戌", "九月"),
```

#### 修复1.2：五虎遁法月份顺序
```python
# 修复前
month_index = GanzhiCalculator.DIZHI.index(month_zhi)
month_gan_index_in_year = month_index % 10

# 修复后
month_order = ["寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥", "子", "丑"]
month_index_in_order = month_order.index(month_zhi)
month_gan_index_in_year = month_index_in_order % 10
```

**验证结果**：
- 1999年10月17日 → 甲戌（木土）✓
- 2025年12月30日 → 戊子（土水）✓

### 问题2：时柱计算错误

**现象**：
- 输入：1999年10月17日 03时00分
- 期望时柱：壬寅（水木）
- 实际时柱：甲寅（木木）

**原因**：五鼠遁表数据错误

**修复位置**：`src/bazi_calculator/core/calendar.py`

#### 修复2.1：壬日五鼠遁表
```python
# 修复前（错误）
["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],  # 壬日

# 修复后（正确）
["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],  # 壬日
```

**口诀验证**："丁壬庚子居"
- 壬日子时起庚子
- 子：庚、丑：辛、寅：壬 ✓

#### 修复2.2：癸日五鼠遁表
```python
# 修复前（错误）
["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"],  # 癸日

# 修复后（正确）
["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],  # 癸日
```

**口诀验证**："戊癸何方发，壬子是真途"
- 癸日子时起壬子 ✓
- 子：壬、丑：癸、寅：甲、酉：辛 ✓

**验证结果**：
- 壬日寅时 → 壬寅 ✓
- 癸日酉时 → 辛酉 ✓

## 节气映射表修正

### 修复前的错误映射
```python
"秋分": ("未", "七月"),     # ❌ 错误
"寒露": ("未", "七月"),     # ❌ 错误
"霜降": ("未", "七月"),     # ❌ 错误
"立冬": ("申", "八月"),     # ❌ 错误
```

### 修复后的正确映射
```python
"白露": ("酉", "八月"),
"秋分": ("酉", "八月"),
"寒露": ("戌", "九月"),     # ✅ 正确
"霜降": ("戌", "九月"),
"立冬": ("亥", "十月"),
"小雪": ("亥", "十月"),
"大雪": ("子", "十一月"),
```

### 传统节气-月份对应关系
```
寅月：立春到惊蛰
卯月：惊蛰到清明
辰月：清明到立夏
巳月：立夏到芒种
午月：芒种到小暑
未月：小暑到立秋
申月：立秋到白露
酉月：白露到寒露
戌月：寒露到立冬       ← 10月17日在此范围
亥月：立冬到大雪
子月：大雪到小寒
丑月：小寒到立春
```

## 五鼠遁表修正

### 完整的五鼠遁表（修复后）
```python
WUSHU_DUN_TABLE = [
    ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"],  # 甲日 - 甲己还加甲
    ["丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁"],  # 乙日 - 乙庚丙作初
    ["戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"],  # 丙日 - 丙辛从戊起
    ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],  # 丁日 - 丁壬庚子居
    ["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],  # 戊日 - 戊癸何方发
    ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"],  # 己日 - 甲己还加甲
    ["丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁"],  # 庚日 - 乙庚丙作初
    ["戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"],  # 辛日 - 丙辛从戊起
    ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],  # 壬日 - 丁壬庚子居
    ["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],  # 癸日 - 戊癸何方发
]
```

### 五鼠遁口诀
```
甲己还加甲
乙庚丙作初
丙辛从戊起
丁壬庚子居
戊癸何方发，壬子是真途
```

## 测试用例验证

### 测试用例1
**输入**：1999年10月17日 03时00分，男性

**结果**：
- 年柱：己卯（土木）✓
- 月柱：甲戌（木土）✓（从癸未/乙酉修复）
- 日柱：壬寅（水木）✓
- 时柱：壬寅（水木）✓（从甲寅修复）

### 测试用例2
**输入**：2025年12月30日 18时00分，女性

**结果**：
- 年柱：乙巳（木火）✓
- 月柱：戊子（土水）✓
- 日柱：癸酉（水金）✓
- 时柱：辛酉（金金）✓（从癸酉修复）

## 修复总结

### 修复的文件
- `src/bazi_calculator/core/calendar.py` - 核心算法文件

### 修复的内容
1. 节气到月份的映射错误（3处）
2. 五虎遁法月份顺序计算错误
3. 壬日五鼠遁表错误
4. 癸日五鼠遁表错误

### 验证结果
- 所有测试用例通过 ✓
- 月柱计算准确 ✓
- 时柱计算准确 ✓
- 符合传统八字算法 ✓

## 技术细节

### 五虎遁法
五虎遁法用于计算月干，口诀为：
```
甲己之年丙作首，乙庚之岁戊为头
丙辛之岁寻庚上，丁壬壬寅顺水流
若问戊癸何处起，甲寅之上好追求
```

### 五鼠遁法
五鼠遁法用于计算时干，口诀为：
```
甲己还加甲，乙庚丙作初
丙辛从戊起，丁壬庚子居
戊癸何方发，壬子是真途
```

### 节气与月份的关系
八字月份以节气为界，而非月份为界：
- 寅月：立春到惊蛰
- 卯月：惊蛰到清明
- ...
- 戌月：寒露到立冬

## 参考资料

1. 八字计算原理
2. 节气计算方法
3. 干支纪年法
4. 五虎遁法和五鼠遁法

## 更新日志

### v1.1.0 - 算法修复
- ✅ 修复月柱节气映射错误
- ✅ 修复五虎遁法月份顺序
- ✅ 修复壬日五鼠遁表
- ✅ 修复癸日五鼠遁表
- ✅ 验证所有测试用例通过

### v1.0.0 - 初始版本
- ✅ 基本八字计算功能
- ✅ 节气计算功能
- ✅ 五行分析功能